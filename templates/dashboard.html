{% extends "base.html" %}

{% block title %}{{ profile.name }} - Level {{ profile.level }} {{ profile.character_class }}{% endblock %}

{% block content %}
<div class="min-h-screen p-4 md:p-6">
    <!-- Welcome Header -->
    <div class="text-center mb-8">
        <h1 class="font-title text-4xl text-transparent bg-gradient-to-r from-holographic to-cyan-bright bg-clip-text mb-2">
            Welcome back, {{ profile.name }}
        </h1>
        <p class="text-xl text-gray-400">
            Level {{ profile.level }} {{ profile.character_class }}
        </p>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-3 gap-4 md:gap-6">
        
        <!-- Left Column: Character Info & Stats -->
        <div class="space-y-6">
            <!-- Character Card -->
            <div class="cyber-panel p-6">
                <div class="text-center mb-6">
                    <!-- Avatar placeholder -->
                    <div class="w-16 h-16 md:w-24 md:h-24 mx-auto mb-4 bg-gradient-to-br from-cyan-400 to-purple-400 rounded-full flex items-center justify-center">
                        <span class="text-lg md:text-2xl font-title text-white">{{ profile.name|first }}</span>
                    </div>
                    <h2 class="text-2xl font-title text-holographic">{{ profile.name }}</h2>
                    <p class="text-gray-400">{{ profile.character_class }}</p>
                </div>
                
                <!-- Level & XP Progress -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">Level {{ profile.level }}</span>
                        <span class="text-sm text-gray-400">{{ profile.total_xp }}/{{ profile.xp_to_next_level }} XP</span>
                    </div>
                    <div class="stat-bar h-4">
                        <div class="stat-bar-fill" style="width: {{ xp_progress }}%"></div>
                    </div>
                </div>
            </div>

            <!-- Stats Panel -->
            <div id="stats-container" class="cyber-panel p-6" hx-get="{% url 'refresh_stats' %}" hx-trigger="refreshStats">
                <h3 class="text-xl font-title text-holographic mb-4">Character Stats</h3>
                <div class="space-y-4">
                    <!-- STR -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 md:space-x-3">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-red-500/20 border border-red-400 rounded flex items-center justify-center">
                                <span class="text-xs font-mono font-bold text-red-400">STR</span>
                            </div>
                            <span class="text-gray-300 text-sm md:text-base">Strength</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="stat-bar w-16 md:w-24 h-2">
                                <div class="stat-bar-fill bg-red-400" style="width: {{ profile.strength|floatformat:0 }}%"></div>
                            </div>
                            <span class="text-holographic font-mono text-sm md:text-lg w-6 md:w-8 text-right">{{ profile.strength }}</span>
                        </div>
                    </div>
                    
                    <!-- INT -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 md:space-x-3">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-blue-500/20 border border-blue-400 rounded flex items-center justify-center">
                                <span class="text-xs font-mono font-bold text-blue-400">INT</span>
                            </div>
                            <span class="text-gray-300 text-sm md:text-base">Intelligence</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="stat-bar w-16 md:w-24 h-2">
                                <div class="stat-bar-fill bg-blue-400" style="width: {{ profile.intelligence|floatformat:0 }}%"></div>
                            </div>
                            <span class="text-holographic font-mono text-sm md:text-lg w-6 md:w-8 text-right">{{ profile.intelligence }}</span>
                        </div>
                    </div>
                    
                    <!-- CHR -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 md:space-x-3">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-purple-500/20 border border-purple-400 rounded flex items-center justify-center">
                                <span class="text-xs font-mono font-bold text-purple-400">CHR</span>
                            </div>
                            <span class="text-gray-300 text-sm md:text-base">Charisma</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="stat-bar w-16 md:w-24 h-2">
                                <div class="stat-bar-fill bg-purple-400" style="width: {{ profile.charisma|floatformat:0 }}%"></div>
                            </div>
                            <span class="text-holographic font-mono text-sm md:text-lg w-6 md:w-8 text-right">{{ profile.charisma }}</span>
                        </div>
                    </div>
                    
                    <!-- END -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 md:space-x-3">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-green-500/20 border border-green-400 rounded flex items-center justify-center">
                                <span class="text-xs font-mono font-bold text-green-400">END</span>
                            </div>
                            <span class="text-gray-300 text-sm md:text-base">Endurance</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="stat-bar w-16 md:w-24 h-2">
                                <div class="stat-bar-fill bg-green-400" style="width: {{ profile.endurance|floatformat:0 }}%"></div>
                            </div>
                            <span class="text-holographic font-mono text-sm md:text-lg w-6 md:w-8 text-right">{{ profile.endurance }}</span>
                        </div>
                    </div>
                    
                    <!-- LCK -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 md:space-x-3">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-yellow-500/20 border border-yellow-400 rounded flex items-center justify-center">
                                <span class="text-xs font-mono font-bold text-yellow-400">LCK</span>
                            </div>
                            <span class="text-gray-300 text-sm md:text-base">Luck</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="stat-bar w-16 md:w-24 h-2">
                                <div class="stat-bar-fill bg-yellow-400" style="width: {{ profile.luck|floatformat:0 }}%"></div>
                            </div>
                            <span class="text-holographic font-mono text-sm md:text-lg w-6 md:w-8 text-right">{{ profile.luck }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Effects -->
            {% if active_effects %}
            <div class="cyber-panel p-6">
                <h3 class="text-xl font-title text-cyan-400 mb-4">Active Effects</h3>
                <div class="space-y-2">
                    {% for effect in active_effects %}
                    <div class="flex items-center justify-between p-2 bg-gray-800/50 round border border-{% if effect.effect_type == 'buff' %}green{% elif effect.effect_type == 'debuff' %}red{% else %}gray{% endif %}-400">
                        <span class="text-sm text-gray-300">{{ effect.name }}</span>
                        <span class="text-xs text-{% if effect.effect_type == 'buff' %}green{% elif effect.effect_type == 'debuff' %}red{% else %}gray{% endif %}-400">
                            {{ effect.effect_type|upper }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Center Column: Daily Quests -->
        <div class="space-y-6">
            <div class="cyber-panel p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-title text-holographic">Daily Quests</h3>
                    <button hx-post="{% url 'generate_quests' %}" 
                            hx-trigger="click"
                            hx-target="#quest-results"
                            class="btn-secondary px-4 py-2 text-sm">
                        Generate New
                    </button>
                </div>
                
                <div id="quest-results" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Hidden div to handle quest completion responses -->
                    <div id="dashboard-quest-response-handler" style="display: none;"></div>
                    {% for quest in daily_quests %}
                    <div class="quest-card cyber-panel p-3 md:p-4 bg-gray-900/50">
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm md:text-lg font-semibold text-holographic mb-1 truncate">{{ quest.title }}</h4>
                                <p class="text-gray-300 text-xs md:text-sm mb-2 line-clamp-2">{{ quest.description }}</p>
                                <div class="flex flex-wrap items-center gap-2 text-xs">
                                    <span class="text-gray-400">
                                        <span class="text-holographic">Difficulty:</span> {{ quest.difficulty|capfirst }}
                                    </span>
                                    <span class="text-gray-400">
                                        <span class="text-holographic">Reward:</span> +{{ quest.reward_xp }} XP
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col items-center space-y-2 sm:ml-4 flex-shrink-0">
                                {% if not quest.completed %}
                                <button hx-post="{% url 'complete_quest' quest.id %}"
                                        hx-trigger="click"
                                        hx-target="#dashboard-quest-response-handler"
                                        hx-swap="innerHTML"
                                        class="btn-primary px-3 md:px-6 py-2 text-xs md:text-sm w-full sm:w-auto">
                                    Complete
                                </button>
                                {% else %}
                                <div class="flex items-center space-x-2 text-green-400">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm font-mono">COMPLETE</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Reward breakdown -->
                        {% if quest.reward_strength or quest.reward_intelligence or quest.reward_charisma or quest.reward_endurance or quest.reward_luck %}
                        <div class="flex items-center space-x-3 mt-3 pt-3 border-t border-gray-700">
                            <span class="text-xs text-gray-400">Bonus:</span>
                            {% if quest.reward_strength %}<span class="text-xs text-red-400">+{{ quest.reward_strength }} STR</span>{% endif %}
                            {% if quest.reward_intelligence %}<span class="text-xs text-blue-400">+{{ quest.reward_intelligence }} INT</span>{% endif %}
                            {% if quest.reward_charisma %}<span class="text-xs text-purple-400">+{{ quest.reward_charisma }} CHR</span>{% endif %}
                            {% if quest.reward_endurance %}<span class="text-xs text-green-400">+{{ quest.reward_endurance }} END</span>{% endif %}
                            {% if quest.reward_luck %}<span class="text-xs text-yellow-400">+{{ quest.reward_luck }} LCK</span>{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center py-8">
                        <p class="text-gray-400 mb-4">No active quests found.</p>
                        <button hx-post="{% url 'generate_quests' %}" 
                                hx-trigger="click"
                                hx-target="#quest-results"
                                class="btn-primary px-6 py-3">
                            Generate Daily Quests
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right Column: Quick Actions & Habits -->
        <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="cyber-panel p-6">
                <h3 class="text-xl font-title text-cyan-400 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="{% url 'chat' %}" class="block w-full btn-primary py-3 text-center">
                        ðŸ’¬ Chat with AI Mentor
                    </a>
                    <a href="{% url 'quests' %}" class="block w-full btn-secondary py-3 text-center">
                        ðŸ“‹ View All Quests
                    </a>
                    <a href="{% url 'stats' %}" class="block w-full btn-secondary py-3 text-center">
                        ðŸ“Š View Progress Stats
                    </a>
                </div>
            </div>

            <!-- Active Habits -->
            {% if active_habits %}
            <div class="cyber-panel p-6">
                <h3 class="text-xl font-title text-cyan-400 mb-4">Active Habits</h3>
                <div class="space-y-3">
                    {% for habit in active_habits %}
                    <div class="p-3 bg-gray-800/50 rounded border border-gray-600">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-semibold text-gray-300">{{ habit.name }}</h4>
                            <span class="text-xs text-cyan-400 font-mono">{{ habit.streak_count }} day streak</span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <span>{{ habit.frequency|capfirst }}</span>
                            <span>{{ habit.total_completions }} total</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- System Status -->
            <div class="cyber-panel p-6">
                <h3 class="text-xl font-title text-cyan-400 mb-4">System Status</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">AI Mentor</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-xs text-green-400 font-mono">ONLINE</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Quest Generator</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-xs text-green-400 font-mono">ACTIVE</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Stats Tracking</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                            <span class="text-xs text-cyan-400 font-mono">MONITORING</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Auto-refresh stats every 30 seconds
    setInterval(() => {
        htmx.trigger('#stats-container', 'refreshStats');
    }, 30000);

    // Handle quest completion
    document.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.requestConfig.verb === 'post' && evt.detail.requestConfig.path.includes('complete-quest')) {
            const button = evt.detail.elt;
            console.log('Dashboard quest completion response:', evt.detail.xhr.responseText);
            
            if (evt.detail.xhr.status === 200) {
                try {
                    const response = JSON.parse(evt.detail.xhr.responseText);
                    if (response.success && response.xp_gained) {
                        showXPGain(response.xp_gained, response.stat_gains);
                        
                        if (response.new_level && response.new_level > {{ profile.level }}) {
                            setTimeout(() => {
                                showLevelUp(response.new_level);
                            }, 1000);
                        }
                        
                        // Update button to completed state
                        button.innerHTML = `
                            <div class="flex items-center space-x-2 text-green-400">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm font-mono">COMPLETE</span>
                            </div>
                        `;
                        button.disabled = true;
                        button.classList.remove('btn-primary');
                        button.classList.add('cursor-not-allowed');
                        
                        // Update quest card to show completion
                        const questCard = button.closest('.quest-card');
                        if (questCard) {
                            questCard.classList.add('opacity-75');
                            const questTitle = questCard.querySelector('h4');
                            if (questTitle) {
                                questTitle.classList.add('text-green-400');
                                questTitle.classList.remove('text-holographic');
                            }
                        }
                        
                        // Refresh stats
                        htmx.trigger('#stats-container', 'refreshStats');
                        
                    } else if (response.message) {
                        showNotification(response.message, response.success ? 'success' : 'warning');
                    }
                } catch (e) {
                    console.error('Error parsing dashboard quest response:', e);
                    showNotification('Quest completed, but there was an issue parsing the response', 'warning');
                }
            } else if (evt.detail.xhr.status === 403) {
                showNotification('Permission denied. Please refresh the page and try again.', 'error');
                resetDashboardButton(button);
            } else {
                showNotification('Failed to complete quest. Please try again.', 'error');
                resetDashboardButton(button);
            }
        }
    });
    
    function resetDashboardButton(button) {
        button.classList.remove('opacity-50');
        button.disabled = false;
        button.innerHTML = 'Complete';
    }

    // Add loading states to buttons
    document.addEventListener('htmx:beforeRequest', function(evt) {
        const button = evt.detail.elt;
        if (button.tagName === 'BUTTON') {
            button.classList.add('opacity-50');
            button.disabled = true;
        }
    });

    document.addEventListener('htmx:afterRequest', function(evt) {
        const button = evt.detail.elt;
        if (button.tagName === 'BUTTON') {
            button.classList.remove('opacity-50');
            button.disabled = false;
        }
    });
</script>
{% endblock %} 